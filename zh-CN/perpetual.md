# 永续合约

## 简介

MCDEX永续合约是一种类似期货合约的金融衍生品，与传统期货合约不同的是，永续合约没有到期日期。MCDEX永续合约使用了部署在以太坊上的[Mai Protocol V2](https://github.com/mcdexio/mai-protocol-v2) 智能合约。

目前，MCDEX永续合约有两个交易界面，对应两种交易方式：

- **订单簿**：通过订单簿匹配交易双方，类似于中心化交易所的永续合约。
- [**自动做市商(AMM)**](#自动做市商)：与AMM作为对手方进行交易，完全去中心化。

自动做市商始终提供服务，并以预设的定价公式作为交易对手为用户提供交易服务。当然，交易者也可以选择订单簿进行交易，以获得更好的流动性、更小的滑点，以及类似于中心化交易所的交易体验。

MCDEX永续合约通过[实时资金费率](#资金费率)将永续合约的价格锚定到[指数价格](#指数预言机)。

如果永续合约的交易价格高于指数价格，则多头头寸持有人向空头头寸持有人支付资金费用。通过这个方式增加了多头头寸持有者的持有成本，导致他们最终进行了卖出操作，从而将永续合约价格压低到指数价格。

同样，如果永续合约的交易价格低于指数价格，则空头头寸持有人会向多头头寸持有人支付资金费用。通过这个方式增加了空头持有者的持有成本，导致他们最终进行了买入操作，从而将永续合约价格抬高到指数价格。

MCDEX永续合约持续计算永续合约的标记价格与Chainlink的ETH / USD指数价格之间的差值。并用这个差值来计算永续合约的8小时资金费率。

资金费用每秒钟自动计算一次，并实现到已实现盈亏中（也是可用交易余额的一部分）。您可以随时从保证金账户中提取这些已实现的盈亏。


## 合约参数

### ETH-PERP

| 合约代号 | ETH-PERP |
| ------------------- | :---------------------------------------------: |
| 标的资产/代号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 来自Chainlink的ETH/USD价格 |
| 交易时间 | 每周 7天 * 24小时 |
| 最小合约数量 | 100 USD |
| 合约价值 | 1 USD |
| 初始保证金 | 10% |
| 维持保证金 | 7.5%。强制平仓罚金2.5% |
| 标记价格 | 该永续合约交易时的估计价格。它可以（暂时）偏离实际的永续合约市场成交价，以防止有人恶意操纵市场。标记价格的计算方法是：指数价格+公允价-指数价格的600秒EMA。永续合约公允价是自动做市商（AMM）的中间价。 |
| 交割/到期时间 |	没有交割/到期时间 |
| 交割方式 | ETH现金交割 |
| 合约类型 | [反向合约](#普通合约和反向合约) |

### LINK-PERP

| 合约代号 | LINK-PERP |
| ------------------- | :---------------------------------------------: |
| 标的资产/代号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 来自Chainlink的LINK/USD价格 |
| 交易时间 | 每周 7天 * 24小时 |
| 最小合约数量 | 100 USD |
| 合约价值 | 1 USD |
| 初始保证金 | 20% |
| 维持保证金 | 15%。强制平仓罚金15% |
| 标记价格 | 该永续合约交易时的估计价格。它可以（暂时）偏离实际的永续合约市场成交价，以防止有人恶意操纵市场。标记价格的计算方法是：指数价格+公允价-指数价格的600秒EMA。永续合约公允价是自动做市商（AMM）的中间价。 |
| 交割/到期时间 |	没有交割/到期时间 |
| 交割方式 | ETH现金交割 |
| 合约类型 | [反向合约](#普通合约和反向合约) |

## 交易示例

每位交易者有一个[隔离保证金](#隔离保证金) 账户。一个保证金账户包含 `保证金余额` 和 `仓位`。用户可以存钱到 `保证金账户` ，实时结算的PNL也会实现到 `保证金账户`中。 PNL的计算方法与合同类型有关，我将在以下示例中进行解释。

### ETH-PERP

ETH-PERP是一种[反向合约](#普通合约和反向合约)。它的保证金是ETH，合约价值1美元。

| 行为 | 保证金余额 | 持仓 | 指数价格 (USD/ETH) | 说明 |
| ------ | :------------: | :------: | :-------------------: | ------- |
| 存入1 ETH | **1 ETH** | 0 USD | 200 | 存入抵押物到保证金账户 |
| 在价格为200时买入/看涨1000 USD | 1 ETH | **+1000 USD** | 200 | `持仓均价 = 200`, `杠杆 = (1000 / 200) / 1 = 5x` |
| 链上指数价格上涨 | **1.122 ETH** | +1000 USD | 205 | `多头的盈亏 = (1 / 持仓均价 - 1 / 退出价格) * 仓位`(&ast;&ast;)，`杠杆 = (1000 / 205) / 1.122 = 4.35x` |
| 在价格为205时买入/看涨100 USD | 1.122 ETH | **0 USD** | 205 | 平仓 |

&ast;&ast; 此示例假设[标记价格](#标记价格) = [指数价格](#指数预言机)

## 普通合约和反向合约

假设一个以美元报价的ETH合约。那么在这个合约中，ETH是基础货币，USD是计价货币。

在普通合约（或正向合约）中，保证金和盈亏都以计价货币计算。因此，一个ETH普通合约，它将以USD计价，并用USD抵押和结算。

但是，对于反向合约，保证金和盈亏均以基础货币计价。 因此，一个ETH反向合约将用ETH抵押和结算。

另外，上面的反向合约也可以看作ETH对USD的普通合约，并用ETH进行抵押和结算。 只需将美元报价求倒数，然后反转买/卖方，即可将反向合约转换为相应的普通合约。在MCDEX Mai2智能合约中，只有普通合约。 但是，为了改善用户体验，MCDEX在前端对ETH-PERP进行了上述转换，让用户可以操作反向合约。

## 标记价格

标记价格是永续合约在交易时候的估计价格。 标记价格可能会（暂时）偏离实际的市场价格，以防止有人操纵市场。

要了解如何计算标记价格，我们得先确定“公允价格”。为了使标记价格和资金利率独立于任何链下设施，MCDEX使用链上自动做市商（AMM）的“中间价格”作为“公允价格”。更多详细信息请在相应的章节中查看。

标记价格是用指数价格和公允价格计算出来的，方法是将计算公允价格和指数价格差值的600秒指数移动平均值（EMA），然后再加上指数价格。

```标记价格 = 指数价格 + 600秒EMA (公允价格 - 指数价格)```

此外，标记价格只在MCDEX指数价格的+/- 0.6%波动。在任何情况下，标记价格与指数价格都不会相差超过0.6%。

每秒都会重新计算600秒EMA，因此总共有600个时间段，最近一秒的权重为2 /（600 + 1）= 0.333%。

## 资金费率

永续合约中正的资金费率和负的资金费率在计算方法上是相同的。

正的资金费率意味着多头（多头头寸持有者）将为空头（空头头寸持有者）支付资金费用。同样，负的资金费率意味着空头（空头头寸持有者）将为多头（多头头寸持有者）支付资金费用。在任何给定的时间点，8小时资金费率计算如下：

**我们先计算溢价率**

```溢价率 = ((标记价格 - 指数价格) / 指数价格) * 100%```

**接下来我们计算出资金费率**

根据溢价率，可以通过应用阻尼器来计算出资金费率。如果溢价率在-0.2%到0.2%之间，则资金费率为零。

如果溢价率低于-0.2%，则资金费率将为溢价率 + 0.2%。

如果溢价率高于0.2%，则出费率将为溢价率 - 0.2%。

通常，资金费率 = 最大值(0.2%, 溢价率) + 最小值(-0.2%, 溢价率)

**最后我们计算时间分数**

```时间分数 = 资金费率时间分数 / 8 小时```

实际付的资金费用是通过将资金费率乘以ETH的头寸规模和以小时为单位的时间分数而得出的。
```资金费用 = 资金费率 * ETH头寸规模 * 时间分数```

已付或已收到的资金费用将持续加入现金余额/从现金余额扣除。

MCDEX平台不收取任何资金费用：MCDEX在资金费用机制上不收取任何费用，所有资金在永续合约的参与者之间流转。这使得资金费用成为零和游戏，多头收取空头的所有资金费用，反之亦然。

## 隔离保证金

MCDEX永续合约采用隔离保证金模式。

隔离保证金是分配给单个头寸的保证金余额。隔离保证金模式允许交易者通过限制分配给每个头寸的保证金数量来管理各个头寸的风险。每个头寸分配的保证金余额可以单独调整。

在隔离保证金模式下，交易者承受的损失永远不会超过保证金余额。最坏的情况是，交易者的头寸将与保证金余额一起被清算。

由于头寸的有效杠杆等于 `头寸价值 / 保证金余额`，交易者可以通过调整保证金余额来调整头寸的杠杆。向隔离保证金账户存入更多保证金会降低有效杠杆，而从隔离保证金账户中提取保证金则会提高有效杠杆。

当保证金余额大于初始保证金时，交易者就可以增加头寸。当保证金余额小于维持保证金时，头寸将被清算。

## 自动做市商

MCDEX致力于让永续合约完全去中心化。

MCDEX的两个主要目标是：
1. 资金费率和标记价格必须由链上提供。
2. 不需要链下的设施，交易者也能正常进行合约交易。

为了实现上述目标，MCDEX在其永续合约中引入了自动做市商（AMM）。自动做市商为永续合约提供了链上的流动性。通过AMM，交易者可以随时以AMM的价格公式计算出的价格进行交易。

设计AMM时，价格公式有多种选择。为谨慎起见，我们现在采用常数乘积（x * y = k）模型作为价格模型。该模型的优点是它已在Uniswap中得到了广泛使用，并且已经得到了很好的验证。永续合约中使用此模型的缺点是缺乏资金效率。在深入研究的基础上，我们在未来将升级AMM的定价公式，以提高的资金效率。

AMM在其流动性池中拥有合适的多头头寸和保证金。令x为AMM流动性池的可用保证金。令y为流动性池的多头头寸数量。

我们将多头头寸的杠杆设为1倍。那么，当流动性池中的多头头寸在价格P时增减Δy时：
- 头寸占用的保证金增加/减少了 Δy * P
- 可用保证金 x 增加/减少了 Δy * P.

这样的方法使AMM的头寸始终被完全抵押（因此AMM的头寸永远不会被清算。因此，源自AMM中间价格的资金率和标记价格始终在链上可用）。

交易价格由x和y的比率确定，以便保留乘积x * y。
交易价格P的公式可以从x * y得出：

```
买入 Δy 合约的价格: P( Δy ) = x / ( y - Δy )
卖出 Δy 合约的价格: P( Δy ) = x / ( y + Δy )
```

其中，|Δy| 是交易者想要交易的金额。当交易者向该流动性池出售时，Δy为正。当交易者从流动性池中购买时，Δy为负。交易后的x和y如下：

```
Δx = P( Δy )∙Δy
x' = x - Δx
y' = y + Δy
```

可证:
```
x∙y = x'∙y'
```
```x/y``` 的值被称为AMM的“的中间价格”。 它用来计算资金费率和标记价格。

使用AMM进行交易需要支付0.3%的交易费，作为流动性提供者的奖励将留在池中。

## 向AMM添加流动性

### 添加流动性

任何人都可以将流动性添加到AMM的流动性池中并获得池中的份额。要添加流动性，交易者需要调用智能合约来执行以下操作：
1. 将抵押代币发送到流动性池中。假设抵押代币的数量为c。
2. 与AMM交易，相当于做空，价格为x / y。则交易金额：

```
Liquidity(c) = c / (2x / y) = c∙y/(2x)
```

操作后，x和y将更新为：

```
x' = x + c/2
y' = y + Liquidity(c) = y + c∙y/(2x)
x'/y' = (x + c/2) / (y + c∙y/(2x)) = (x∙(2x + c))/(y∙(2x + c)) = x/y
```

中间价格 ```x/y``` 在此操作后不会更改。
流动性提供者获取池的份额。

在添加流动性时，流动性提供者将抵押代币和多头头寸都添加到池中：1.提供者将抵押代币发送到池中；2.同时，流动性提供者将与流动性池进行卖出交易，这将增加流动性池的多头头寸。添加完成后，流动性提供者在其保证金帐户中有空头头寸，池增加相应的多头头寸，全网净头寸为零。当交易者跟池子进行交易时，池的头寸大小会发生变化。流动性提供者会持有头寸，这是风险敞口。当然，流动性提供者会获得交易费作为奖励。

在 [此处](en-US/perpetual-tech#add-liquidity-to-amm)查看更多示例。


### 提取流动性
份额持有者可以从池中消除流动性并赎回份额代币。让s为交易者在资金池中的份额（百分比）。要提取流动性，交易者需要调用智能合约来执行以下操作：
1. 与自动做市商（AMM）进行交易，交易价格为 ```x/y```。交易金额为 ```c = y∙s```
2. 从流动性池中获得 ```2x∙s``` 抵押代币。

可以证明，操作后 ```x/y``` 没有变。

在 [此处](en-US/perpetual-tech#remove-liquidity-from-amm)查看更多示例。


## 与订单簿交易
为了提高流动性，MCDEX提供了链下订单簿来交易永续合约。订单撮合服务器只用来匹配交易者的订单。服务器永远无法更改交易者的链上保证金账户。

为了与订单簿进行交易，交易者需要签名他们的订单并将订单发送到订单簿服务器。订单簿服务器匹配订单簿中的订单，并将匹配结果发送到区块链上的智能合约。智能合约首先验证订单的签名和匹配结果。如果通过验证，则根据匹配结果进行交易。

### 目标杠杆

无论与自动做市商（AMM）还是与订单簿进行交易，头寸的有效杠杆始终为 ```头寸价值 / 保证金余额``` ，而未结头寸的最大杠杆为 ```1 / 初始保证金```

然而，交易者可以在与订单簿进行交易时设置“目标杠杆”。订单簿引擎使用目标杠杆来计算头寸保证金和订单保证金，并取消那些可能将头寸杠杆推高目标杠杆的订单。

须知，目标杠杆率只是链下订单簿服务器中的设置。即使交易者设置了低目标杠杆，链上头寸的有效杠杆也可能高于或低于目标杠杆。例如，交易者从保证金账户中提取抵押代币，从而导致有效杠杆的增加。再例如，头寸的利润不断增加，这导致保证金余额增加，有效杠杆降低。

### 头寸和订单保证金
订单簿服务器会计算用于成交新订单的所需保证金，称为订单保证金。如下所示：（普通合同）

```
可用余额 = 保证金余额 - 仓位保证金 - 订单保证金
仓位保证金 = 标记价格 * 仓位大小 / 目标杠杆
```

```订单保证金``` 是订单簿服务器为正在进行的订单预留的保证金。已完成的订单将无需订单保证金。对于已成交并成为头寸的订单，订单保证金计算如下：

```
进行中的订单 = 订单价格 * 订单规模 / 目标杠杆 + 潜在损失 + 交易费
买单的潜在损失 = 最大值((订单价格 - 标记价格) * 订单规模, 0)
卖单的潜在损失 = 最大值((标记价格 - 订单价格) * 订单规模, 0)
```

买单和卖单的订单保证金分别计算。总订单保证金为：
```
订单保证金 = 最大值(买单的保证金, 卖单的保证金)
```

### 经纪人（Broker）

经纪人帮助交易者完成交易。它是订单簿的一个普通以太坊地址。每个订单的签名中都需要设置经纪人。为了实现收取交易手续费，经纪人必须在订单数据结构中分配挂单方/吃单方费率。如果费率为负，则经纪人需要给交易者支付交易费。

## AMM与订单簿之间的关系

请注意，我们的永续合约可以在没有订单簿的情况下使用。假如订单簿由于某种原因而不可用，但此时永续合约系统仍然可用，因为资金费率是由自动做市商（AMM）提供，而自动做市商（AMM）是纯链上的。链下订单簿只是加强了这个系统。随着套利者在订单簿和AMM之间流转流动性，自动做市商（AMM）将具有更好的流动性和价格。该系统的设计旨在为用户提供满意的链上体验。

## 指数预言机

指数价格源来自Chainlink。MCDEX 永续合约依赖于指数预言机的公平性和正确性。目前，已经出现一些加密项目致力于提供去中心化的预言机服务，虽然不是很完美，但我们认为在早期将Chainlink用作预言机是一个不错的选择。

## 自动清算

Mai2智能合约按以下方式计算保证金帐户（普通合约）：

```
保证金余额 = 现金余额 + 已实现盈亏
多头已实现盈亏 = (标记价格 – 买入均价) * 头寸规模
空头已实现盈亏 = (买入均价 - 标记价格) * 头寸规模
维持保证金 = 标记价格 * 头寸规模 * 维持保证金率
初始保证金 = 标记价格 * 头寸规模 * 初始保证金率
```

清算价格是使保证金余额为零的标记价格。

当账户的保证金余额低于维持保证金时，账户中的头寸将逐渐减少，以使初始保证金低于账户中的权益。

任何人都可以在未经帐户所有者许可的情况下清算不安全的保证金帐户。清算人以标记价格接管不安全头寸，账户向清算人和保险基金支付清算罚款。由于清算后将不安全头寸转移到清算人，清算人必须有足够的保证金余额以保持头寸安全。

如果清算时的标价比破产价差，则标价和破产价之差就是清算损失。损失首先由保险基金弥补。如果资金不足以弥补损失，智能合约将使损失社会化。在这种情况下，所有对手持仓者根据其仓位大小分担损失。

## 全局结算

由于当前区块链基础设施的效率低下，清算机制受到限制。在极端情况下，例如剧烈的价格变化，错误的指数价格输入等，将造成大量的社会损失。在此期间，MCDEX将评估情况，并在必要时确定结算价格，并将合同纳入全局结算情况。当进入这种情况时，所有交易将被中止。没有足够保证金的账户将以结算价清算。并且系统损失将被社会化。清算结束后，用户可以按结算价结算其头寸，并提取所有剩余的保证金余额。

由于全局结算的重要性，MCDEX将尽快建立一个由社区主导的治理委员会，该委员会将制定详细的全球结算触发机制和处理程序。

## 部署的合约

### ETH-PERP

|合约|描述|地址|
|---|---|---|
|Perpetual      |永续合约的核心逻辑，包括保证金账户，盈亏等|[0x220a9f0DD581cbc58fcFb907De0454cBF3777f76](https://etherscan.io/address/0x220a9f0DD581cbc58fcFb907De0454cBF3777f76)|
|AMM            |自动做市商                             |[0xAAaC8434217575643B2D2aB6f12CE8600C625520](https://etherscan.io/address/0xAAaC8434217575643B2D2aB6f12CE8600C625520)|
|Proxy          |自动做市商保证金账户                                      |[0x05c363D2B9AFc36b070fe2c61711280eDC214678](https://etherscan.io/address/0x05c363D2B9AFc36b070fe2c61711280eDC214678)|
|GlobalConfig   |全局治理参数                            |[0x71e77Ffbbfd4418ED47981927738b5425c187F64](https://etherscan.io/address/0x71e77Ffbbfd4418ED47981927738b5425c187F64)|
|Exchange       |订单簿交易逻辑                              |[0xbF5c98A4eD00C28957b6e15A01102DC2568D2650](https://etherscan.io/address/0xbF5c98A4eD00C28957b6e15A01102DC2568D2650)|
|PriceFeeder    |指数预言机                                            |[0xcfa46E1b666fd91Bf39028055D506c1e4cA5aD6E](https://etherscan.io/address/0x9B2D7D7f7b2810Ef2be979fc2ACebe6097d9563A)|
|ShareToken     |自动做市商的份额代币                                  |[0xAe694FB9DCD1E6195519c0056B2aB19380B26FF2](https://etherscan.io/address/0xAe694FB9DCD1E6195519c0056B2aB19380B26FF2)|
|ContractReader |批量阅读器，以减少通信消耗   |[0x53C9Df248150AD849bD1BadD3C83b0f6cb735052](https://etherscan.io/address/0x53C9Df248150AD849bD1BadD3C83b0f6cb735052)|
